# All-Influencer Docker ê´€ë¦¬ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”
All-Influencer í”„ë¡œì íŠ¸ì˜ Docker ì»¨í…Œì´ë„ˆ ë° ì„œë¹„ìŠ¤ ê´€ë¦¬ì— ëŒ€í•œ ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ³ Docker êµ¬ì„±

### ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚     Adminer     â”‚    â”‚   App Services  â”‚
â”‚   Port: 5432    â”‚â—„â”€â”€â–ºâ”‚   Port: 8080    â”‚    â”‚                 â”‚
â”‚   Database      â”‚    â”‚   DB Admin      â”‚    â”‚   Web: 3000     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   API: 3001     â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### docker-compose.yml êµ¬ì„±
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: allinfluencer-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: allinfluencer
      POSTGRES_USER: allinfluencer
      POSTGRES_PASSWORD: allinfluencer
      TZ: Asia/Seoul
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./apps/api/prisma/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U allinfluencer -d allinfluencer"]
      interval: 10s
      timeout: 5s
      retries: 5

  adminer:
    image: adminer:4-standalone
    container_name: allinfluencer-adminer
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: dracula
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
    driver: local
```

## ğŸš€ Docker ëª…ë ¹ì–´

### ê¸°ë³¸ ì„œë¹„ìŠ¤ ê´€ë¦¬
```bash
# ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose up -d

# íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì‹œì‘
docker-compose up -d postgres
docker-compose up -d adminer

# ì„œë¹„ìŠ¤ ì¤‘ì§€
docker-compose stop

# ì„œë¹„ìŠ¤ ë° ì»¨í…Œì´ë„ˆ ì œê±°
docker-compose down

# ë³¼ë¥¨ê¹Œì§€ í•¨ê»˜ ì œê±° (ë°ì´í„° ì‚­ì œë¨!)
docker-compose down -v
```

### ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```bash
# ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
docker ps

# ëª¨ë“  ì»¨í…Œì´ë„ˆ í™•ì¸ (ì¤‘ì§€ëœ ê²ƒ í¬í•¨)
docker ps -a

# ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
docker-compose logs -f

# íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê·¸ë§Œ í™•ì¸
docker-compose logs -f postgres
docker-compose logs -f adminer
```

### ì»¨í…Œì´ë„ˆ ê´€ë¦¬
```bash
# ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker-compose restart postgres

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì ‘ì†
docker exec -it allinfluencer-postgres bash
docker exec -it allinfluencer-adminer sh

# ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
docker stats

# ì»¨í…Œì´ë„ˆ ìƒì„¸ ì •ë³´ í™•ì¸
docker inspect allinfluencer-postgres
```

## ğŸ—„ï¸ PostgreSQL ê´€ë¦¬

### ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì†
```bash
# Docker ì»¨í…Œì´ë„ˆë¥¼ í†µí•œ ì§ì ‘ ì ‘ì†
docker exec -it allinfluencer-postgres psql -U allinfluencer -d allinfluencer

# ë¡œì»¬ psql í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©
psql -h localhost -p 5432 -U allinfluencer -d allinfluencer
```

### ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
```bash
# ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
docker exec allinfluencer-postgres pg_dump -U allinfluencer -d allinfluencer > backup_$(date +%Y%m%d_%H%M%S).sql

# íŠ¹ì • í…Œì´ë¸”ë§Œ ë°±ì—…
docker exec allinfluencer-postgres pg_dump -U allinfluencer -d allinfluencer -t users > users_backup.sql

# ìŠ¤í‚¤ë§ˆë§Œ ë°±ì—… (ë°ì´í„° ì œì™¸)
docker exec allinfluencer-postgres pg_dump -U allinfluencer -d allinfluencer --schema-only > schema_backup.sql
```

### ë°ì´í„°ë² ì´ìŠ¤ ë³µì›
```bash
# ë°±ì—… íŒŒì¼ë¡œë¶€í„° ë³µì›
docker exec -i allinfluencer-postgres psql -U allinfluencer -d allinfluencer < backup.sql

# ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ì— ë³µì›
docker exec -i allinfluencer-postgres createdb -U allinfluencer new_database
docker exec -i allinfluencer-postgres psql -U allinfluencer -d new_database < backup.sql
```

### ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
```bash
# ë°ì´í„°ë² ì´ìŠ¤ ì™„ì „ ì´ˆê¸°í™” (ì£¼ì˜: ëª¨ë“  ë°ì´í„° ì‚­ì œë¨!)
docker-compose down -v
docker-compose up -d postgres

# Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¤ì‹œ ì‹¤í–‰
cd apps/api
npx prisma migrate reset
npx prisma migrate dev
```

## ğŸ›ï¸ Adminer ê´€ë¦¬

### ì ‘ì† ì •ë³´
- **URL**: http://localhost:8080
- **ì‹œìŠ¤í…œ**: PostgreSQL
- **ì„œë²„**: postgres (Docker ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ)
- **ì‚¬ìš©ìëª…**: allinfluencer
- **ë¹„ë°€ë²ˆí˜¸**: allinfluencer
- **ë°ì´í„°ë² ì´ìŠ¤**: allinfluencer

### Adminer ê³ ê¸‰ ê¸°ëŠ¥
```bash
# Adminer í…Œë§ˆ ë³€ê²½
# ì»¨í…Œì´ë„ˆ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ADMINER_DESIGN ìˆ˜ì • ê°€ëŠ¥
# ì˜µì…˜: default, nette, jush, pepa-linha, konya, pappu687, pokorny, hydra, lucas, flat, nicu, ng9

# ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ (í•„ìš”ì‹œ)
docker exec -it allinfluencer-adminer sh
# /var/www/html/plugins/ ë””ë ‰í„°ë¦¬ì— í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
```

## ğŸ’¾ ë³¼ë¥¨ ê´€ë¦¬

### ë³¼ë¥¨ í™•ì¸
```bash
# ëª¨ë“  ë³¼ë¥¨ ë¦¬ìŠ¤íŠ¸
docker volume ls

# í”„ë¡œì íŠ¸ ê´€ë ¨ ë³¼ë¥¨ë§Œ í™•ì¸
docker volume ls | grep all-influencer

# ë³¼ë¥¨ ìƒì„¸ ì •ë³´
docker volume inspect all-influencer_postgres_data
```

### ë³¼ë¥¨ ë°±ì—…
```bash
# ë³¼ë¥¨ ë°ì´í„° ë°±ì—…
docker run --rm -v all-influencer_postgres_data:/data -v $(pwd):/backup ubuntu tar czf /backup/postgres_volume_backup.tar.gz -C /data .

# ë°±ì—… ë³µì›
docker run --rm -v all-influencer_postgres_data:/data -v $(pwd):/backup ubuntu tar xzf /backup/postgres_volume_backup.tar.gz -C /data
```

### ë³¼ë¥¨ ì •ë¦¬
```bash
# ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
docker volume prune

# íŠ¹ì • ë³¼ë¥¨ ì‚­ì œ (ì£¼ì˜: ë°ì´í„° ì†ì‹¤!)
docker volume rm all-influencer_postgres_data
```

## ğŸŒ ë„¤íŠ¸ì›Œí‚¹

### ë„¤íŠ¸ì›Œí¬ í™•ì¸
```bash
# Docker ë„¤íŠ¸ì›Œí¬ ë¦¬ìŠ¤íŠ¸
docker network ls

# í”„ë¡œì íŠ¸ ë„¤íŠ¸ì›Œí¬ ìƒì„¸ ì •ë³´
docker network inspect all-influencer_default
```

### ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ 
```bash
# ê°™ì€ ë„¤íŠ¸ì›Œí¬ ë‚´ì—ì„œ ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ í†µì‹  ê°€ëŠ¥
# postgres ì»¨í…Œì´ë„ˆì—ì„œ adminer ì»¨í…Œì´ë„ˆë¡œ ì—°ê²°:
# Host: postgres, Port: 5432

# ì™¸ë¶€ì—ì„œ ì ‘ê·¼:
# Host: localhost, Port: 5432 (í¬íŠ¸ ë§¤í•‘ì„ í†µí•´)
```

## ğŸ” ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### í—¬ìŠ¤ ì²´í¬
```bash
# PostgreSQL í—¬ìŠ¤ ì²´í¬
docker exec allinfluencer-postgres pg_isready -U allinfluencer -d allinfluencer

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker-compose ps

# íŠ¹ì • ì„œë¹„ìŠ¤ í—¬ìŠ¤ ìƒíƒœ
docker inspect --format='{{.State.Health.Status}}' allinfluencer-postgres
```

### ë¡œê·¸ ë¶„ì„
```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
docker-compose logs -f --tail=100

# íŠ¹ì • ì‹œê°„ëŒ€ ë¡œê·¸
docker-compose logs --since="2024-01-01T00:00:00" --until="2024-01-01T23:59:59"

# ë¡œê·¸ íŒŒì¼ë¡œ ì €ì¥
docker-compose logs > application.log
```

### ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
```bash
# ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
docker stats --no-stream

# íŠ¹ì • ì»¨í…Œì´ë„ˆë§Œ ëª¨ë‹ˆí„°ë§
docker stats allinfluencer-postgres allinfluencer-adminer

# ì‹œìŠ¤í…œ ì „ì²´ Docker ì‚¬ìš©ëŸ‰
docker system df
```

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

#### 1. í¬íŠ¸ ì¶©ëŒ
```bash
Error: bind: address already in use
```
**í•´ê²° ë°©ë²•:**
```bash
# í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
lsof -i :5432
lsof -i :8080

# í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë˜ëŠ” í¬íŠ¸ ë³€ê²½
docker-compose down
# docker-compose.ymlì—ì„œ í¬íŠ¸ ë³€ê²½ í›„
docker-compose up -d
```

#### 2. ë³¼ë¥¨ ê¶Œí•œ ë¬¸ì œ
```bash
Permission denied
```
**í•´ê²° ë°©ë²•:**
```bash
# Docker ì»¨í…Œì´ë„ˆ ì‚¬ìš©ì í™•ì¸
docker exec allinfluencer-postgres id

# ê¶Œí•œ ìˆ˜ì •
sudo chown -R $USER:$USER ./postgres_data
```

#### 3. ë©”ëª¨ë¦¬ ë¶€ì¡±
```bash
container killed (OOMKilled)
```
**í•´ê²° ë°©ë²•:**
```bash
# ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì • (docker-compose.yml)
services:
  postgres:
    mem_limit: 512m
    memswap_limit: 1g
```

#### 4. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ
```bash
connection refused
```
**í•´ê²° ë°©ë²•:**
```bash
# ë„¤íŠ¸ì›Œí¬ ì¬ìƒì„±
docker-compose down
docker network prune
docker-compose up -d
```

## ğŸ”§ ì„±ëŠ¥ ìµœì í™”

### PostgreSQL ìµœì í™”
```bash
# postgresql.conf ì„¤ì •ì„ ìœ„í•œ ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ìƒì„±
# ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
POSTGRES_INITDB_ARGS="--auth-host=scram-sha-256"
```

### ì»¨í…Œì´ë„ˆ ìµœì í™”
```yaml
# docker-compose.ymlì—ì„œ ë¦¬ì†ŒìŠ¤ ì œí•œ
services:
  postgres:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
```

## ğŸ—ï¸ í”„ë¡œë•ì…˜ ë°°í¬

### í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-strong_production_password}
    volumes:
      - /var/lib/postgresql/data:/var/lib/postgresql/data
    restart: always
```

### SSL/TLS ì„¤ì •
```yaml
# nginx í”„ë¡ì‹œ ì¶”ê°€
nginx:
  image: nginx:alpine
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf
    - ./ssl:/etc/ssl/certs
```

### ë³´ì•ˆ ê°•í™”
```bash
# ê¸°ë³¸ í¬íŠ¸ ë³€ê²½
ports:
  - "15432:5432"  # ê¸°ë³¸ 5432 ëŒ€ì‹ 

# ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬
networks:
  database:
    driver: bridge
  web:
    driver: bridge
```

## ğŸ“Š ë°±ì—… ì „ëµ

### ìë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
docker exec allinfluencer-postgres pg_dump -U allinfluencer -d allinfluencer > "backup_${DATE}.sql"

# 7ì¼ ì´ìƒëœ ë°±ì—… íŒŒì¼ ì‚­ì œ
find . -name "backup_*.sql" -mtime +7 -delete
```

### í¬ë¡ íƒ­ ì„¤ì •
```bash
# ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ë°±ì—…
0 2 * * * /path/to/backup.sh
```

## ğŸ”„ ì—…ë°ì´íŠ¸ ë° ìœ ì§€ë³´ìˆ˜

### ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
```bash
# ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
docker-compose pull

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ìƒˆ ì´ë¯¸ì§€ ì ìš©)
docker-compose up -d --force-recreate
```

### ì •ê¸° ìœ ì§€ë³´ìˆ˜
```bash
# ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
docker image prune -a

# ì‹œìŠ¤í…œ ì „ì²´ ì •ë¦¬
docker system prune -a --volumes
```

---
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„ 10ì›” 4ì¼  
**ë²„ì „**: 1.0.0  
**Docker Compose ë²„ì „**: 3.8  
**PostgreSQL ë²„ì „**: 16-alpine  
**Adminer ë²„ì „**: 4-standalone
